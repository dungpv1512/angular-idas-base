<div class="tochuc-list">
  <nz-card class="main-card" [nzBordered]="false">
    <!-- Header Section -->
    <div class="header-section">
      <div class="header-left">
        <div class="title-section">
          <span nz-icon nzType="apartment" nzTheme="twotone" class="title-icon"></span>
          <h1>{{ title }}</h1>
        </div>
        <p class="subtitle">{{ subtitle }}</p>
      </div>
      @if (showCreateButton) {
      <div class="header-actions">
        <button nz-button nzType="primary" nzSize="large" (click)="onCreateClick()">
          <span nz-icon nzType="plus"></span>
          Thêm mới
        </button>
      </div>
      }
    </div>

    <nz-divider></nz-divider>

    <!-- Toolbar Section -->
    <div class="toolbar-section">
      <div class="search-section">
        <app-base-tags-input
          [(tags)]="searchTags"
          [searchFields]="searchFields"
          [placeholder]="'Nhập giá trị và Enter để thêm...'"
          [debounceTime]="500"
          [maxTags]="10"
          (tagsChange)="onSearchTagsChange($event)"
        />
      </div>
      <div class="view-switcher">
        <nz-radio-group [(ngModel)]="viewMode" (ngModelChange)="switchView($event)" nzButtonStyle="solid">
          <label nz-radio-button nzValue="table">
            <span nz-icon nzType="table"></span>
            Bảng
          </label>
          <label nz-radio-button nzValue="tree">
            <span nz-icon nzType="apartment"></span>
            Cây
          </label>
        </nz-radio-group>
      </div>
    </div>

    <nz-divider></nz-divider>

    <!-- Content Section -->
    <div class="content-section">
      <!-- Table View -->
      @if (viewMode === 'table') {
      <div class="table-wrapper">
        @if (checkable) {
          <!-- Custom table with checkbox -->
          <nz-table
            #table
            [nzData]="displayData"
            [nzLoading]="loading"
            [nzShowPagination]="false"
            [nzBordered]="true"
            [nzScroll]="scroll"
            [nzVirtualItemSize]="54"
            [nzVirtualMaxBufferPx]="200"
            [nzVirtualMinBufferPx]="100"
          >
            <thead>
              <tr>
                <th
                  [nzWidth]="'60px'"
                  [nzChecked]="isAllChecked"
                  [nzIndeterminate]="isIndeterminate"
                  (nzCheckedChange)="onAllChecked($event)"
                  [nzShowCheckbox]="multiple"
                ></th>
                @for (column of displayColumns; track $index) {
                  <th
                    [nzWidth]="column.width || null"
                    [nzAlign]="column.align || 'left'"
                  >
                    {{ column.title }}
                  </th>
                }
              </tr>
            </thead>
            <tbody>
              @for (node of displayData; track node.key) {
                <tr>
                  <td
                    [nzChecked]="setOfCheckedId.has(node.data.Id)"
                    (nzCheckedChange)="onItemChecked(node.data.Id, $event)"
                    [nzShowCheckbox]="true"
                  ></td>
                  @for (column of displayColumns; track $index; let first = $first) {
                    <td 
                      [nzAlign]="column.align || 'left'" 
                      [nzIndentSize]="first ? (node.level || 0) * 20 : 0" 
                      [nzShowExpand]="first && hasChildren(node)" 
                      [(nzExpand)]="node.expand"
                      (nzExpandChange)="onExpandChange(node, $event)"
                    >
                      {{ node.data[column.key] }}
                    </td>
                  }
                </tr>
              }
            </tbody>
          </nz-table>
        } @else {
          <!-- Normal table without checkbox -->
          <app-base-table 
            [data]="treeTableData" 
            [columns]="displayColumns" 
            [actions]="displayActions" 
            [loading]="loading" 
            [bordered]="true"
            [scroll]="scroll" 
            [isTree]="true" 
            [showPagination]="false" 
            [virtualScroll]="true" 
          />
        }
      </div>
      }

      <!-- Tree View -->
      @if (viewMode === 'tree') {
      <div class="tree-wrapper">
        @if (searchTags.length > 0 && filteredTreeData.length === 0) {
          <nz-empty 
            nzNotFoundImage="simple" 
            [nzNotFoundContent]="'Không tìm thấy kết quả phù hợp'"
          ></nz-empty>
        } @else {
          <app-base-tree 
            [nodes]="filteredTreeData.length > 0 ? filteredTreeData : treeData" 
            [checkable]="checkable" 
            [checkedKeys]="checkedKeys"
            [showLine]="true" 
            [expandAll]="searchTags.length > 0"
            (nodeClick)="onTreeNodeClick($event)"
            (nzCheckBoxChange)="onCheckChange($event)"
          />
        }
      </div>
      }
    </div>
  </nz-card>
</div>